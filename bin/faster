#!/usr/bin/env node

var program  = require("commander"),
    _        = require('underscore')._,
    config   = require("../lib/config"),
    core     = require("../lib/core"),
    log      = require("../lib/log"),
    server   = require("../lib/server");

program
  .version(config.version)
  .option("-d, --dev",              "development mode: auto-generate changed files")
  .option("-b, --build",            "build mode: build a complete version, with packed assets")
  .option("-s, --server",           "serve content from the target directory on localhost")
  .option("-t, --target  <value>",  "specify a different target directory (default ./public)")
  .option("-f, --from    <value>",  "specify a different source directory (default ./content)")
  .option("-p, --port    <value>",  "specify a different server port (default 3000)")
  .option("-i, --ignore  <value>",  "ignore files with value in path (csv)", config.split)
  .parse(process.argv);

if(!program.server && !program.dev && !program.build) {
  program.help();
}

config.silent = false;
config.extend(_.pick(program, [
  "source", "target", "port", "dev", "build", "server", "ignore"
]));

var preamble = function() {
  log();
  log(3, "Source:", config.appdir);
  log(3, "Target:", config.pubdir);
  log();
};

var devmode = function() {
  log(1, "Development mode!");
  preamble();
  core.regenAll();
  core.watch();
};

var buildmode = function() {
  log(1, "Building site!");
  preamble();
  core.regenAll();
};

if(config.server) server();
if(config.dev && !config.build) devmode();
if(config.build) buildmode();
